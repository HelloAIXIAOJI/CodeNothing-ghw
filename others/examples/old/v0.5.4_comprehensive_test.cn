using lib <io>;
using ns std;

// CodeNothing v0.5.4 ç»¼åˆåŠŸèƒ½æµ‹è¯•
// å±•ç¤ºå‡½æ•°æŒ‡é’ˆæ•°ç»„å’ŒLambdaé—­åŒ…çš„å®Œæ•´åŠŸèƒ½

// åŸºç¡€æ•°å­¦å‡½æ•°
fn add(a : int, b : int) : int {
    return a + b;
};

fn subtract(a : int, b : int) : int {
    return a - b;
};

fn multiply(a : int, b : int) : int {
    return a * b;
};

fn divide(a : int, b : int) : int {
    if (b != 0) {
        return a / b;
    } else {
        return 0;
    };
};

fn main() : int {
    std::println("=== CodeNothing v0.5.4 ç»¼åˆåŠŸèƒ½æµ‹è¯• ===");
    std::println("");
    
    // æµ‹è¯•1ï¼šå‡½æ•°æŒ‡é’ˆæ•°ç»„åŸºç¡€åŠŸèƒ½
    testFunctionPointerArrayBasics();
    
    // æµ‹è¯•2ï¼šLambdaå‡½æ•°æŒ‡é’ˆæ•°ç»„
    testLambdaFunctionPointerArray();
    
    // æµ‹è¯•3ï¼šLambdaé—­åŒ…åŸºç¡€åŠŸèƒ½
    testLambdaClosureBasics();
    
    // æµ‹è¯•4ï¼šå¤šå˜é‡é—­åŒ…
    testMultiVariableClosure();
    
    // æµ‹è¯•5ï¼šå¤åˆè¡¨è¾¾å¼å’Œé«˜çº§ç”¨æ³•
    testAdvancedUsage();
    
    std::println("");
    std::println("=== ğŸ‰ CodeNothing v0.5.4 æ‰€æœ‰åŠŸèƒ½æµ‹è¯•å®Œæˆï¼ ===");
    return 0;
};

fn testFunctionPointerArrayBasics() : void {
    std::println("1. å‡½æ•°æŒ‡é’ˆæ•°ç»„åŸºç¡€åŠŸèƒ½æµ‹è¯•");
    std::println("===========================");
    
    // å‡½æ•°æŒ‡é’ˆæ•°ç»„å£°æ˜å’Œåˆå§‹åŒ–
    operations : []*fn(int, int) : int = [add, subtract, multiply, divide];
    
    // æ•°ç»„ç´¢å¼•è®¿é—®
    firstOp : *fn(int, int) : int = operations[0];
    result1 : int = firstOp(20, 8);
    std::println("operations[0](20, 8) = " + result1);
    
    // ç›´æ¥è°ƒç”¨è¯­æ³•
    result2 : int = operations[1](20, 8);
    std::println("operations[1](20, 8) = " + result2);
    
    result3 : int = operations[2](20, 8);
    std::println("operations[2](20, 8) = " + result3);
    
    result4 : int = operations[3](20, 8);
    std::println("operations[3](20, 8) = " + result4);
    
    std::println("");
};

fn testLambdaFunctionPointerArray() : void {
    std::println("2. Lambdaå‡½æ•°æŒ‡é’ˆæ•°ç»„æµ‹è¯•");
    std::println("=========================");
    
    // çº¯Lambdaå‡½æ•°æŒ‡é’ˆæ•°ç»„
    lambdas : []*fn(int, int) : int = [
        ((a, b) => a + b),           // åŠ æ³•
        ((a, b) => a - b),           // å‡æ³•
        ((a, b) => a * b),           // ä¹˜æ³•
        ((a, b) => a * a + b * b)    // å¹³æ–¹å’Œ
    ];
    
    // ç›´æ¥è°ƒç”¨Lambdaæ•°ç»„å…ƒç´ 
    result1 : int = lambdas[0](6, 4);
    std::println("lambdas[0](6, 4) = " + result1 + " (åŠ æ³•)");
    
    result2 : int = lambdas[1](6, 4);
    std::println("lambdas[1](6, 4) = " + result2 + " (å‡æ³•)");
    
    result3 : int = lambdas[2](6, 4);
    std::println("lambdas[2](6, 4) = " + result3 + " (ä¹˜æ³•)");
    
    result4 : int = lambdas[3](6, 4);
    std::println("lambdas[3](6, 4) = " + result4 + " (å¹³æ–¹å’Œ: 6Â² + 4Â² = 52)");
    
    // æ··åˆæ•°ç»„ï¼šå‡½æ•°å’ŒLambda
    mixed : []*fn(int, int) : int = [add, ((a, b) => a * b), subtract];
    result5 : int = mixed[1](7, 3);
    std::println("mixed[1](7, 3) = " + result5 + " (Lambdaä¹˜æ³•)");
    
    std::println("");
};

fn testLambdaClosureBasics() : void {
    std::println("3. Lambdaé—­åŒ…åŸºç¡€åŠŸèƒ½æµ‹è¯•");
    std::println("=========================");
    
    // å¤–éƒ¨å˜é‡
    multiplier : int = 5;
    
    // Lambdaæ•è·å¤–éƒ¨å˜é‡
    multiplyByFactor : *fn(int) : int = (x => x * multiplier);

    result1 : int = multiplyByFactor(8);
    std::println("multiplyByFactor(8) = " + result1 + " (8 * 5 = 40)");

    result2 : int = multiplyByFactor(12);
    std::println("multiplyByFactor(12) = " + result2 + " (12 * 5 = 60)");
    
    // å­—ç¬¦ä¸²é—­åŒ…æµ‹è¯•æš‚æ—¶è·³è¿‡ï¼ˆéœ€è¦å­—ç¬¦ä¸²æ‹¼æ¥æ”¯æŒï¼‰
    
    std::println("");
};

fn testMultiVariableClosure() : void {
    std::println("4. å¤šå˜é‡é—­åŒ…æµ‹è¯•");
    std::println("=================");
    
    // å¤šä¸ªå¤–éƒ¨å˜é‡
    base : int = 10;
    factor : int = 3;
    offset : int = 5;
    
    // Lambdaæ•è·å¤šä¸ªå¤–éƒ¨å˜é‡
    complexCalc : *fn(int) : int = (x => x * factor + base + offset);
    
    result1 : int = complexCalc(4);
    std::println("complexCalc(4) = " + result1 + " (4 * 3 + 10 + 5 = 27)");
    
    result2 : int = complexCalc(7);
    std::println("complexCalc(7) = " + result2 + " (7 * 3 + 10 + 5 = 36)");
    
    // é—­åŒ…æ•°ç»„
    closures : []*fn(int) : int = [
        (x => x + base),           // åŠ åŸºæ•°
        (x => x * factor),         // ä¹˜å› å­
        (x => x + offset)          // åŠ åç§»
    ];
    
    result3 : int = closures[0](15);
    std::println("closures[0](15) = " + result3 + " (15 + 10 = 25)");
    
    result4 : int = closures[1](15);
    std::println("closures[1](15) = " + result4 + " (15 * 3 = 45)");
    
    result5 : int = closures[2](15);
    std::println("closures[2](15) = " + result5 + " (15 + 5 = 20)");
    
    std::println("");
};

fn testAdvancedUsage() : void {
    std::println("5. å¤åˆè¡¨è¾¾å¼å’Œé«˜çº§ç”¨æ³•æµ‹è¯•");
    std::println("===========================");
    
    // é«˜çº§ç”¨æ³•ï¼šå‡½æ•°æŒ‡é’ˆæ•°ç»„ + é—­åŒ…
    threshold : int = 50;
    
    // åˆ›å»ºå¸¦é—­åŒ…çš„å‡½æ•°æŒ‡é’ˆæ•°ç»„
    processors : []*fn(int) : int = [
        (x => x * 2),                    // åŒå€
        (x => x + threshold),            // åŠ é˜ˆå€¼
        (x => x * x),                    // å¹³æ–¹
        (x => x + 1)                         // åŠ ä¸€
    ];
    
    testValue : int = 8;
    
    result1 : int = processors[0](testValue);
    std::println("processors[0](" + testValue + ") = " + result1 + " (åŒå€)");
    
    result2 : int = processors[1](testValue);
    std::println("processors[1](" + testValue + ") = " + result2 + " (åŠ é˜ˆå€¼)");
    
    result3 : int = processors[2](testValue);
    std::println("processors[2](" + testValue + ") = " + result3 + " (å¹³æ–¹)");
    
    // å‡½æ•°æŒ‡é’ˆæ•°ç»„çš„æ–¹æ³•è°ƒç”¨
    std::println("å‡½æ•°æŒ‡é’ˆæ•°ç»„ä¿¡æ¯:");
    firstProcessor : *fn(int) : int = processors[0];
    std::println("  ç¬¬ä¸€ä¸ªå…ƒç´ ç±»å‹: " + firstProcessor.getReturnType());
    std::println("  ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯Lambda: " + firstProcessor.isLambda());
    
    std::println("");
};
