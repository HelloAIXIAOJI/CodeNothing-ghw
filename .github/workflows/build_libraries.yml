name: 构建CodeNothing库文件

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      libraries:
        description: '要构建的库列表 (all 表示全部, 或用逗号分隔的名称列表如 io,example)'
        required: true
        default: 'all'
  # 发布版本时自动触发
  release:
    types: [created]
  # 标签推送时自动触发
  push:
    tags:
      - 'v*'

# 添加权限设置
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  prepare:
    name: 准备库列表
    runs-on: ubuntu-latest
    outputs:
      library_matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      
      - id: set-matrix
        name: 准备库矩阵
        run: |
          # 如果是手动触发并指定了库，则使用指定的库
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.libraries }}" != "all" ]]; then
            # 使用提供的库列表
            LIBRARIES=$(echo "${{ github.event.inputs.libraries }}" | tr ',' '\n' | jq -R . | jq -cs .)
          else
            # 否则构建所有库
            LIBRARIES=$(find . -maxdepth 1 -type d -name "library_*" | sed 's|./library_||g' | jq -R . | jq -cs .)
          fi
          echo "matrix=${LIBRARIES}" >> $GITHUB_OUTPUT
        shell: bash

  build:
    name: 构建库
    needs: prepare
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.prepare.outputs.library_matrix) }}
        include:
          # Windows 架构
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            lib_extension: 'dll'
            archive_format: 'zip'
            platform_name: 'windows-x64'
          - runner: windows-latest
            target: i686-pc-windows-msvc
            lib_extension: 'dll'
            archive_format: 'zip'
            platform_name: 'windows-x32'
          - runner: windows-latest
            target: aarch64-pc-windows-msvc
            lib_extension: 'dll'
            archive_format: 'zip'
            platform_name: 'windows-arm64'

          # Linux 架构
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_extension: 'so'
            archive_format: 'tar.gz'
            platform_name: 'linux-x64'
          - runner: ubuntu-latest
            target: i686-unknown-linux-gnu
            lib_extension: 'so'
            archive_format: 'tar.gz'
            platform_name: 'linux-x32'
          - runner: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            lib_extension: 'so'
            archive_format: 'tar.gz'
            platform_name: 'linux-arm64'
          - runner: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            lib_extension: 'so'
            archive_format: 'tar.gz'
            platform_name: 'linux-arm32'

          # macOS 架构
          - runner: macos-latest
            target: x86_64-apple-darwin
            lib_extension: 'dylib'
            archive_format: 'tar.gz'
            platform_name: 'macos-x64'
          - runner: macos-latest
            target: aarch64-apple-darwin
            lib_extension: 'dylib'
            archive_format: 'tar.gz'
            platform_name: 'macos-arm64'

          # Android 架构
          - runner: ubuntu-latest
            target: aarch64-linux-android
            lib_extension: 'so'
            archive_format: 'tar.gz'
            platform_name: 'android-arm64'

    steps:
    - uses: actions/checkout@v3

    - name: 设置Rust工具链
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        override: true

    # 安装交叉编译依赖
    - name: 安装交叉编译依赖 (Linux)
      if: matrix.runner == 'ubuntu-latest'
      run: |
        case "${{ matrix.target }}" in
          i686-unknown-linux-gnu)
            sudo apt-get update
            sudo apt-get install -y gcc-multilib g++-multilib
            ;;
          aarch64-unknown-linux-gnu)
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            ;;
          armv7-unknown-linux-gnueabihf)
            sudo apt-get update
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            ;;
          aarch64-linux-android)
            # Android NDK 将通过 cargo 自动处理
            echo "Android target will be handled by cargo"
            ;;
        esac

    # 设置 Android NDK (如果需要)
    - name: 设置 Android NDK
      if: matrix.target == 'aarch64-linux-android'
      run: |
        # 下载并设置 Android NDK
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        export ANDROID_NDK_HOME=$PWD/android-ndk-r25c
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "CC_aarch64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
        echo "CXX_aarch64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++" >> $GITHUB_ENV
        echo "AR_aarch64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
    
    - name: 检查库目录是否存在
      id: check_dir
      run: |
        if [ -d "library_${{ matrix.library }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "警告: 库 ${{ matrix.library }} 的目录不存在，跳过构建"
        fi
      shell: bash
    
    - name: 获取库配置
      if: steps.check_dir.outputs.exists == 'true'
      id: get_config
      run: |
        if [ -f "library_${{ matrix.library }}/library.json" ]; then
          OUTPUT_NAME=$(jq -r '.output_name // "${{ matrix.library }}"' library_${{ matrix.library }}/library.json)
        else
          OUTPUT_NAME="${{ matrix.library }}"
        fi
        echo "output_name=${OUTPUT_NAME}" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: 构建库
      if: steps.check_dir.outputs.exists == 'true'
      run: |
        cd library_${{ matrix.library }}
        cargo build --release --target ${{ matrix.target }}
      shell: bash
    
    - name: 创建输出目录
      if: steps.check_dir.outputs.exists == 'true'
      run: mkdir -p library-package
      shell: bash
    
    - name: 复制构建产物 (Windows)
      if: steps.check_dir.outputs.exists == 'true' && contains(matrix.target, 'windows')
      run: |
        LIB_PATH="library_${{ matrix.library }}/target/${{ matrix.target }}/release/${{ steps.get_config.outputs.output_name }}.dll"
        if [ -f "$LIB_PATH" ]; then
          cp "$LIB_PATH" "library-package/${{ matrix.library }}.${{ matrix.lib_extension }}"
        else
          echo "找不到库文件，尝试备选路径..."
          # 尝试Cargo.toml中的包名
          PACKAGE_NAME=$(grep -m 1 "name" "library_${{ matrix.library }}/Cargo.toml" | cut -d'"' -f2 | tr -d '\r')
          cp "library_${{ matrix.library }}/target/${{ matrix.target }}/release/${PACKAGE_NAME}.dll" "library-package/${{ matrix.library }}.${{ matrix.lib_extension }}"
        fi
      shell: bash

    - name: 复制构建产物 (Linux/macOS/Android)
      if: steps.check_dir.outputs.exists == 'true' && !contains(matrix.target, 'windows')
      run: |
        LIB_PATH="library_${{ matrix.library }}/target/${{ matrix.target }}/release/lib${{ steps.get_config.outputs.output_name }}.${{ matrix.lib_extension }}"
        if [ -f "$LIB_PATH" ]; then
          cp "$LIB_PATH" "library-package/${{ matrix.library }}.${{ matrix.lib_extension }}"
        else
          echo "找不到库文件，尝试备选路径..."
          # 尝试Cargo.toml中的包名
          PACKAGE_NAME=$(grep -m 1 "name" "library_${{ matrix.library }}/Cargo.toml" | cut -d'"' -f2 | tr -d '\r')
          cp "library_${{ matrix.library }}/target/${{ matrix.target }}/release/lib${PACKAGE_NAME}.${{ matrix.lib_extension }}" "library-package/${{ matrix.library }}.${{ matrix.lib_extension }}"
        fi
      shell: bash
    
    - name: 创建档案 (Windows)
      if: steps.check_dir.outputs.exists == 'true' && contains(matrix.target, 'windows')
      run: |
        cd library-package
        7z a "../${{ matrix.library }}-${{ matrix.platform_name }}.${{ matrix.archive_format }}" *
      shell: bash

    - name: 创建档案 (Linux/macOS/Android)
      if: steps.check_dir.outputs.exists == 'true' && !contains(matrix.target, 'windows')
      run: |
        tar -czvf "${{ matrix.library }}-${{ matrix.platform_name }}.${{ matrix.archive_format }}" -C library-package .
      shell: bash
    
    - name: 上传构建产物
      if: steps.check_dir.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.library }}-${{ matrix.platform_name }}
        path: ${{ matrix.library }}-${{ matrix.platform_name }}.${{ matrix.archive_format }}

    - name: 创建发布
      if: steps.check_dir.outputs.exists == 'true' && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'release')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ matrix.library }}-${{ matrix.platform_name }}.${{ matrix.archive_format }}
        tag_name: ${{ github.ref_name }}
        draft: false
        generate_release_notes: true

  # 额外的工作以合并所有库为一个包
  package-all:
    name: 打包所有库
    needs: build
    runs-on: ${{ matrix.runner }}
    # 在手动触发并指定'all'或发布版本时打包所有库
    if: ${{ github.event.inputs.libraries == 'all' || github.event_name == 'release' || startsWith(github.ref, 'refs/tags/') }}
    strategy:
      matrix:
        include:
          # Windows 架构
          - runner: windows-latest
            platform_name: 'windows-x64'
            archive_format: 'zip'
          - runner: windows-latest
            platform_name: 'windows-x32'
            archive_format: 'zip'
          - runner: windows-latest
            platform_name: 'windows-arm64'
            archive_format: 'zip'

          # Linux 架构
          - runner: ubuntu-latest
            platform_name: 'linux-x64'
            archive_format: 'tar.gz'
          - runner: ubuntu-latest
            platform_name: 'linux-x32'
            archive_format: 'tar.gz'
          - runner: ubuntu-latest
            platform_name: 'linux-arm64'
            archive_format: 'tar.gz'
          - runner: ubuntu-latest
            platform_name: 'linux-arm32'
            archive_format: 'tar.gz'

          # macOS 架构
          - runner: macos-latest
            platform_name: 'macos-x64'
            archive_format: 'tar.gz'
          - runner: macos-latest
            platform_name: 'macos-arm64'
            archive_format: 'tar.gz'

          # Android 架构
          - runner: ubuntu-latest
            platform_name: 'android-arm64'
            archive_format: 'tar.gz'
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
      
    - name: 准备合并目录
      run: |
        mkdir -p all-libraries
      shell: bash
    
    - name: 解压所有库 (Windows)
      if: contains(matrix.platform_name, 'windows')
      run: |
        for d in *-${{ matrix.platform_name }}; do
          if [ -d "$d" ]; then
            cd "$d"
            7z x "*.zip" -o../all-libraries
            cd ..
          fi
        done
      shell: bash

    - name: 解压所有库 (Linux/macOS/Android)
      if: "!contains(matrix.platform_name, 'windows')"
      run: |
        for d in *-${{ matrix.platform_name }}; do
          if [ -d "$d" ]; then
            cd "$d"
            tar -xzvf *.tar.gz -C ../all-libraries
            cd ..
          fi
        done
      shell: bash
    
    - name: 创建合并档案 (Windows)
      if: contains(matrix.platform_name, 'windows')
      run: |
        7z a "codenothing-all-libraries-${{ matrix.platform_name }}.${{ matrix.archive_format }}" ./all-libraries/*
      shell: bash

    - name: 创建合并档案 (Linux/macOS/Android)
      if: "!contains(matrix.platform_name, 'windows')"
      run: |
        tar -czvf "codenothing-all-libraries-${{ matrix.platform_name }}.${{ matrix.archive_format }}" -C all-libraries .
      shell: bash

    - name: 上传合并构建产物
      uses: actions/upload-artifact@v4
      with:
        name: codenothing-all-libraries-${{ matrix.platform_name }}
        path: codenothing-all-libraries-${{ matrix.platform_name }}.${{ matrix.archive_format }}

    - name: 创建发布
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: codenothing-all-libraries-${{ matrix.platform_name }}.${{ matrix.archive_format }}
        tag_name: ${{ github.ref_name }}
        draft: false
        generate_release_notes: true
